<?xml version="1.0" encoding="UTF-8"?>
<!--

    Licensed under the GPL License. You may not use this file except in compliance with the License.
    You may obtain a copy of the License at

      http://www.gnu.org/licenses/old-licenses/gpl-2.0.html

    THIS PACKAGE IS PROVIDED "AS IS" AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
    WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
    PURPOSE.

-->
<web-app xmlns="http://java.sun.com/xml/ns/javaee"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
						http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
	version="3.0">

	<display-name>PSI Probe for Apache Tomcat</display-name>

	<context-param>
		<param-name>contextConfigLocation</param-name>
		<param-value>
			<![CDATA[
				/WEB-INF/spring-probe-security.xml
			]]>
		</param-value>
	</context-param>

	<listener>
		<listener-class>psiprobe.AwtAppContextClassloaderListener</listener-class>
	</listener>

	<listener>
		<listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
	</listener>

	<!--
		Core dispatcher servlet
	-->
	<servlet>
		<servlet-name>probe</servlet-name>
		<servlet-class>psiprobe.ProbeServlet</servlet-class>
		<init-param>
			<param-name>contextConfigLocation</param-name>
			<param-value>
				<![CDATA[
					/WEB-INF/spring-probe-servlet.xml,
					/WEB-INF/spring-probe-resources.xml,
					/WEB-INF/spring-probe-stats.xml,
					/WEB-INF/spring-probe-controllers.xml
				]]>
			</param-value>
		</init-param>
		<load-on-startup>0</load-on-startup>
	</servlet>

	<servlet-mapping>
		<servlet-name>probe</servlet-name>
		<url-pattern>*.htm</url-pattern>
		<url-pattern>*.ajax</url-pattern>
		<url-pattern>/logs/*</url-pattern>
		<url-pattern>/chart.png</url-pattern>
	</servlet-mapping>

	<!-- Sitemesh filter -->
	<filter>
		<filter-name>sitemesh</filter-name>
		<filter-class>com.opensymphony.module.sitemesh.filter.PageFilter</filter-class>
	</filter>

	<filter-mapping>
		<filter-name>sitemesh</filter-name>
		<url-pattern>/*</url-pattern>
		<dispatcher>FORWARD</dispatcher>
		<dispatcher>REQUEST</dispatcher>
		<dispatcher>ERROR</dispatcher>
	</filter-mapping>

	<!-- Spring Security filter -->
	<filter>
		<filter-name>filterChainProxy</filter-name>
		<filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
	</filter>

	<filter-mapping>
		<filter-name>filterChainProxy</filter-name>
		<url-pattern>/*</url-pattern>
	</filter-mapping>

	<session-config>
		<session-timeout>15</session-timeout>
		<!-- Disable secure cookie until http session issues can be resolved. While tomcat
		will handle this normally with http, spring has been shown to continually create new
		sessions.  This may not be related to spring security but rather spring web mvc.
		<cookie-config>
			<secure>true</secure>
		</cookie-config>
		-->
		<tracking-mode>COOKIE</tracking-mode>
	</session-config>

	<!-- no access error -->
	<error-page>
		<error-code>403</error-code>
		<location>/403.htm</location>
	</error-page>

	<!-- page not found error -->
	<error-page>
		<error-code>404</error-code>
		<location>/404.htm</location>
	</error-page>

	<!-- 500 error -->
	<error-page>
		<error-code>500</error-code>
		<location>/WEB-INF/jsp/errors/servleterror.jsp</location>
	</error-page>

	<!--exception page -->
	<error-page>
		<exception-type>java.lang.Throwable</exception-type>
		<location>/WEB-INF/jsp/errors/servleterror.jsp</location>
	</error-page>

	<context-param>
		<description>Role that can view session attribute values</description>
		<param-name>attribute.value.roles</param-name>
		<param-value>ROLE_MANAGER,ROLE_MANAGER-GUI</param-value>
	</context-param>

	<security-constraint>
		<display-name>No anonymous access</display-name>
		<web-resource-collection>
			<web-resource-name>All areas</web-resource-name>
			<url-pattern>/*</url-pattern>
		</web-resource-collection>
		<auth-constraint>
			<role-name>probeuser</role-name>
			<role-name>poweruser</role-name>
			<role-name>manager</role-name>
			<role-name>manager-gui</role-name>
			<role-name>poweruserplus</role-name>
		</auth-constraint>
		<user-data-constraint>
			<transport-guarantee>NONE</transport-guarantee>
		</user-data-constraint>
	</security-constraint>

	<!-- Defines the Login Configuration for this Application -->
	<login-config>
		<auth-method>BASIC</auth-method>
		<realm-name>PSI Probe</realm-name>
	</login-config>

	<!--Security roles referenced by this web application -->
	<security-role>
		<role-name>manager-gui</role-name>
	</security-role>

	<security-role>
		<role-name>manager</role-name>
	</security-role>

	<security-role>
		<role-name>poweruser</role-name>
	</security-role>

	<security-role>
		<role-name>poweruserplus</role-name>
	</security-role>

	<security-role>
		<role-name>probeuser</role-name>
	</security-role>

</web-app>
